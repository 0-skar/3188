<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Holy Table & Bonorum System</title>
    <style>
        /* --- START OF FONT DEFINITION --- */
        @font-face {
            font-family: 'Enochian';
            src: url('enochian-t.woff2') format('woff2');
        }

        .enochian-font {
            font-family: 'Enochian', sans-serif !important;
            font-size: 1.2em;
            font-weight: normal;
            line-height: 1;
            text-transform: none !important;
        }
        /* --- END OF FONT DEFINITION --- */

        :root {
            --cell-size: 26px;
            --border-color: #333;
            --king-highlight-color: #e63946; /* Red for Kings */
            --prince-highlight-color: #ffdd00; /* Yellow for Princes */
            --minister-highlight-color: #2a9d8f; /* Green for Ministers */
            --bg-color: #f1faee;
            --font-color: #1d3557;
            --table-bg: #fff;
            --corner-bg: #a8dadc;
            --king-start-color: #b3001b; /* Dark Red for start */
            --prince-start-color: #d4a000; /* Dark Yellow for start */
            --b-cell-size: 28px; 
            --b-num-size: 8px; 
            --b-letter-size: 12px; 
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .master-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            width: 100%;
            max-width: 1800px;
        }

        .side-panel {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .font-toggle-wrapper {
            width: 100%;
            text-align: center;
        }

        #toggle-font-btn {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            background-color: #457b9d;
            color: white;
            border: 2px solid #1d3557;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        #toggle-font-btn:hover {
            background-color: #1d3557;
            transform: translateY(-2px);
        }

        #toggle-font-btn.active-enochian {
            background-color: var(--minister-highlight-color);
            border-color: #1a6a61;
        }

        .central-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 50px;
            flex-grow: 1;
            min-width: 0;
        }
        
        .entity-list-wrapper {
            text-align: center;
            width: 100%;
        }

        #princes-list-desktop-main {
            margin-top: 59px;
        }

        .entity-list-wrapper h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            color: #457b9d;
        }

        .entity-list-wrapper ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .entity-list-wrapper button {
            width: 100%;
            padding: 10px;
            margin-bottom: 6px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: var(--table-bg);
            border-radius: 5px;
            transition: all 0.2s ease-in-out;
        }
        
        #bonorum-full-list button {
            font-size: 11px;
            padding: 4px 6px;
            margin-bottom: 4px;
            white-space: normal;
            word-break: break-word;
        }

        #bonorum-full-list {
            margin-top: 620px;
        }

        #bonorum-full-list ul {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .entity-list-wrapper button:hover {
            background-color: #e9e9e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .entity-list-wrapper button.active {
            background-color: #457b9d;
            color: white;
            border-color: #1d3557;
            font-weight: bold;
        }

        .table-container, .loagaeth-container, .bonorum-cross-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%;
        }

        h1, h2 {
            color: var(--font-color);
            text-align: center;
            margin-top: 0;
        }
        h1 { margin-bottom: 20px; }

        .holy-table {
            display: grid;
            grid-template-columns: repeat(23, var(--cell-size));
            grid-template-rows: repeat(23, var(--cell-size));
            border: 2px solid var(--border-color);
            background-color: var(--table-bg);
            padding: 5px;
            position: relative;
        }
        
        #holy-table-image-thumbnail {
            width: 110px;
            height: 158px;
            object-fit: cover;
            display: block;
            margin: 0 auto;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--table-bg);
            padding: 5px;
            cursor: zoom-in;
            transition: all 0.3s ease-in-out;
        }
        
        .zoom-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: zoom-out;
            overflow: hidden;
        }

        .zoom-lightbox.active {
            display: flex;
        }

        .zoom-lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--table-bg);
            padding: 5px;
            cursor: zoom-in;
            transition: transform 0.2s ease-out;
        }

        .zoom-lightbox img.pannable { cursor: grab; }
        .zoom-lightbox img.dragging { cursor: grabbing; }

        #dee-lightbox {
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        #dee-lightbox img { max-height: 70vh; }
        #dee-lightbox .dee-description {
            color: #f1faee;
            max-width: 90vw;
            text-align: center;
            line-height: 1.5;
            font-size: 16px;
        }
        #dee-lightbox .dee-description b { color: #a8dadc; }
        
        .dee-container { text-align: center; }
        .dee-container h2 { font-size: 1.2em; margin-bottom: 10px; }
        
        #dee-thumbnail {
            width: 100%;
            max-width: 150px;
            height: auto;
            border: 2px solid var(--border-color);
            padding: 4px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #dee-thumbnail:hover { transform: scale(1.05); }
        
        .side-image-container { margin-top: 201px; text-align: center; }
        .cross-image-container { margin-top: 365px; text-align: center; }
        .circle-image-container { margin-top: 524px; text-align: center; }
        .tables-image-container { margin-top: 382px; text-align: center; }

        #cross-image-thumbnail, #circle-image-thumbnail, #tables-image-thumbnail, #loagaeth-practice-thumbnail {
            width: 100%;
            max-width: 150px;
            height: auto;
            border: 2px solid var(--border-color);
            padding: 4px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #cross-image-thumbnail:hover, #circle-image-thumbnail:hover, #tables-image-thumbnail:hover, #loagaeth-practice-thumbnail:hover {
            transform: scale(1.05);
        }

        .grid-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .letter-cell {
            font-size: calc(var(--cell-size) * 0.54);
            font-weight: bold;
            text-transform: uppercase;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .corner-cell {
            font-size: calc(var(--cell-size) * 0.77);
            font-weight: bold;
            background-color: var(--corner-bg);
            border: 1px solid var(--border-color);
        }

        .letter-cell.king-highlight { background-color: var(--king-highlight-color); color: white; border-color: var(--king-highlight-color); transform: scale(1.1); }
        .letter-cell.king-start-point { background-color: var(--king-start-color); color: white; }
        .letter-cell.prince-highlight { background-color: var(--prince-highlight-color); color: var(--font-color); border-color: var(--prince-highlight-color); transform: scale(1.1); }
        .letter-cell.prince-start-point { background-color: var(--prince-start-color); color: white; }
        .center-diagram-cell.highlight { background-color: var(--king-highlight-color); color: white; }
        
        .inner-grid-background { position: absolute; top: calc(var(--cell-size) + 5px); left: calc(var(--cell-size) + 5px); width: calc(21 * var(--cell-size)); height: calc(21 * var(--cell-size)); z-index: 1; pointer-events: none; }
        .inner-grid-background::before, .inner-grid-background::after { content: ''; position: absolute; width: 100%; height: 100%; background-color: rgba(168, 218, 220, 0.25); }
        .inner-grid-background::before { clip-path: polygon(50% 0%, 100% 75%, 0% 75%); }
        .inner-grid-background::after { clip-path: polygon(50% 100%, 0% 25%, 100% 25%); }
        .center-diagram-cell { font-size: calc(var(--cell-size) * 0.54); font-weight: bold; color: #000; background-color: rgba(255, 255, 255, 0.75); border: 1px solid #ccc; transition: all 0.3s ease; }

        .loagaeth-table { display: grid; grid-template-rows: repeat(7, var(--cell-size)); border: 2px solid var(--border-color); padding: 5px; background-color: var(--table-bg); transition: grid-template-columns 0.5s ease-in-out, gap 0.5s ease-in-out; }
        .loagaeth-cell { width: var(--cell-size); height: var(--cell-size); display: flex; justify-content: center; align-items: center; border: 1px solid #e0e0e0; font-size: calc(var(--cell-size) * 0.54); font-family: 'Times New Roman', serif; text-transform: lowercase; transition: all 0.3s ease-in-out; }
        .loagaeth-cell.loagaeth-key-highlight { background-color: var(--king-highlight-color); color: white; transform: scale(1.1); }
        .loagaeth-cell.loagaeth-king-name-highlight { background-color: var(--king-highlight-color); color: white; font-weight: bold; }
        .loagaeth-cell.loagaeth-prince-name-highlight { background-color: var(--prince-highlight-color); color: var(--font-color); font-weight: bold; }
        #loagaeth-clickable-area { position: absolute; cursor: pointer; z-index: 10; }

        .bonorum-cross-wrapper { 
            display: grid;
            grid-template-areas: ". north ." "left center right" ". south ."; 
            grid-template-columns: auto auto auto; 
            gap: 5px; 
            margin: 25px 0;
        }
        .bonorum-table { 
            display: grid; 
            background-color: var(--table-bg); 
            border: 2px solid var(--border-color); 
            padding: 5px;
            position: relative;
        }
        #bonorum-table-north { grid-area: north; } #bonorum-table-left { grid-area: left; } #bonorum-table-center { grid-area: center; } #bonorum-table-right { grid-area: right; } #bonorum-table-south { grid-area: south; }
        
        .bonorum-table::before,
        .bonorum-table::after {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: calc(var(--b-letter-size) * 1.33);
            font-weight: bold;
            color: var(--font-color);
            left: 0;
        }
        #bonorum-table-north::before { content: '2 3'; top: calc(-1 * var(--b-cell-size) * 0.8); word-spacing: calc(7 * (var(--b-cell-size) / 2)); }
        #bonorum-table-right::before { content: '4'; top: calc(-1 * var(--b-cell-size) * 0.8); }
        #bonorum-table-left::before { content: '7'; top: calc(-1 * var(--b-cell-size) * 0.8); }
        #bonorum-table-south::after { content: '6 5'; bottom: calc(-1 * var(--b-cell-size) * 0.8); word-spacing: calc(7 * (var(--b-cell-size) / 2)); }

        .bonorum-cell { height: var(--b-cell-size); border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; font-size: var(--b-letter-size); position: relative; transition: background-color: 0.3s; }
        .bonorum-cell span { position: absolute; top: 1px; left: 2px; font-size: var(--b-num-size); color: #666; }
        #bonorum-table-north .bonorum-cell span, #bonorum-table-south .bonorum-cell span { left: 1px; font-size: calc(var(--b-num-size) * 0.85); }
        
        .bonorum-cell.king-highlight { background-color: var(--king-highlight-color); color: white; }
        .bonorum-cell.prince-highlight { background-color: var(--prince-highlight-color); color: var(--font-color); }
        .bonorum-cell.minister-highlight { background-color: var(--minister-highlight-color); color: white; }

        .bonorum-diagram-container { margin-top: 30px; width: 100%; max-width: 800px; align-self: center; }
        .bonorum-diagram-container svg { width: 100%; height: auto; font-family: 'Times New Roman', serif; }
        .diagram-ring { fill: none; stroke: #aaa; stroke-width: 0.5; }
        .diagram-spoke { stroke: #333; stroke-width: 1; }
        .diagram-text { font-size: 11px; text-anchor: middle; dominant-baseline: middle; fill: var(--font-color); transition: all 0.2s; }
        .diagram-number, .diagram-symbol, .diagram-sector-number { text-anchor: middle; dominant-baseline: middle; fill: #666; }
        .diagram-number { font-size: 9px; }
        .diagram-symbol { font-size: 12px; }
        .diagram-sector-number { font-size: 18px; font-weight: bold; fill: #333; }
        .bonorum-diagram-name { cursor: pointer; }
        .bonorum-diagram-name:hover .diagram-text { font-weight: bold; }
        .diagram-text-bg { fill: transparent; transition: fill 0.2s; }
        .bonorum-diagram-name.active .diagram-text { font-weight: bold; }
        .bonorum-diagram-name.active.king .diagram-text-bg { fill: var(--king-highlight-color); }
        .bonorum-diagram-name.active.king .diagram-text { fill: white; }
        .bonorum-diagram-name.active.prince .diagram-text-bg { fill: var(--prince-highlight-color); }
        .bonorum-diagram-name.active.prince .diagram-text { fill: var(--font-color); }
        .bonorum-diagram-name.active.minister .diagram-text-bg { fill: var(--minister-highlight-color); }
        .bonorum-diagram-name.active.minister .diagram-text { fill: white; }
        
        .planetary-kings-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; margin-top: 40px; }
        .planetary-king-square { display: flex; flex-direction: column; align-items: center; flex-basis: 250px; flex-grow: 1; }
        .planetary-king-square h3 { margin: 0 0 8px 0; font-size: 16px; color: var(--font-color); }
        .planetary-king-grid { display: grid; grid-template-columns: repeat(7, var(--cell-size)); grid-template-rows: repeat(6, var(--cell-size)); border: 3px solid var(--border-color); background-color: var(--table-bg); padding: 4px; }
        
        .planetary-king-row { display: contents; }
        .planetary-king-row .letter-cell { cursor: pointer; transition: all 0.2s ease-in-out; }
        .planetary-king-row:hover .letter-cell { background-color: #e9e9e9; }
        .planetary-king-row.selected .letter-cell { transform: scale(1.05); box-shadow: 0 0 8px rgba(0,0,0,0.2); background-color: #a8dadc; }
        
        .diagram-text-bg.planetary-king-highlight { fill: var(--king-highlight-color); }
        .diagram-text-bg.planetary-king-highlight + .diagram-text { fill: white; }
        .diagram-text-bg.planetary-prince-highlight { fill: var(--prince-highlight-color); }
        .diagram-text-bg.planetary-prince-highlight + .diagram-text { fill: var(--font-color); }
        .diagram-text-bg.planetary-minister-highlight { fill: var(--minister-highlight-color); }
        .diagram-text-bg.planetary-minister-highlight + .diagram-text { fill: white; }

        .bonorum-cell.planetary-king-highlight, .loagaeth-cell.planetary-king-highlight, .letter-cell.planetary-king-highlight { background-color: var(--king-highlight-color); color: white; transform: scale(1.1); }
        .bonorum-cell.planetary-prince-highlight, .loagaeth-cell.planetary-prince-highlight, .letter-cell.planetary-prince-highlight { background-color: var(--prince-highlight-color); color: var(--font-color); transform: scale(1.1); }
        .bonorum-cell.planetary-minister-highlight, .loagaeth-cell.planetary-minister-highlight, .letter-cell.planetary-minister-highlight { background-color: var(--minister-highlight-color); color: white; transform: scale(1.1); }
        
        .diagram-symbol#bonorum-symbol-sun.highlight, .diagram-symbol#bonorum-symbol-moon.highlight {
            fill: var(--king-highlight-color);
            font-weight: bold;
        }

        .play-button { background-color: #457b9d; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color: 0.2s; }
        .play-button:hover { background-color: #1d3557; }
        .play-button .icon { transition: all 0.2s ease-in-out; }
        .play-button .play-icon { width: 0; height: 0; border-style: solid; border-width: 7px 0 7px 12px; border-color: transparent transparent transparent white; margin-left: 4px; }
        .play-button .pause-icon { width: 10px; height: 12px; border-style: double; border-width: 0px 0px 0px 10px; border-color: white; }
        .play-button .play-icon { display: block; }
        .play-button .pause-icon { display: none; }
        .play-button.playing .play-icon { display: none; }
        .play-button.playing .pause-icon { display: block; }
        
        /* --- START OF RESPONSIVE STYLES --- */
        /* Portrait Tablet and Mobile */
        @media (max-width: 1200px) { 
            .master-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 50px;
            }
            .central-content { order: 1; width: 100%; }
            .side-panel { order: 2; width: 100%; max-width: 600px; flex-direction: column; align-items: center;}
            .side-panel:last-of-type { order: 3; }
            #princes-list-desktop-main, #bonorum-full-list, .side-image-container, .cross-image-container, .circle-image-container, .tables-image-container { margin-top: 0; }
        }

        @media (max-width: 768px) {
            :root {
                --cell-size: 4.1vw;
                --b-cell-size: 4.4vw;
            }
        }
        @media (max-width: 480px) {
             :root {
                --cell-size: 3.9vw;
                --b-cell-size: 4.2vw;
            }
        }

        /* Horizontal Phone Layout: Force Desktop View & Scale */
        @media (orientation: landscape) and (max-height: 500px) {
            :root {
                /* Use vmin to scale based on the shortest side (height in landscape) */
                --cell-size: 2.2vmin;
                --b-cell-size: 2.4vmin;
                --b-num-size: 1.1vmin;
                --b-letter-size: 1.4vmin;
            }
            body { padding: 10px; }
            .master-container {
                flex-direction: row;
                gap: 20px; /* Reduced gap */
            }
            .central-content, .side-panel, .side-panel:last-of-type {
                order: initial;
            }
            .side-panel {
                width: 220px;
                flex-shrink: 0;
                max-width: none;
                flex-direction: column; /* Restore column layout */
            }
             h1, h2, .entity-list-wrapper h2, .dee-container h2 {
                font-size: 2.2vmin;
            }
             .entity-list-wrapper button {
                font-size: 1.4vmin;
                padding: 0.8vmin;
                margin-bottom: 0.5vmin;
            }
            #bonorum-full-list button {
                font-size: 1.1vmin;
                padding: 0.4vmin;
            }
             /* Restore desktop margins */
            #princes-list-desktop-main { margin-top: 59px; }
            #bonorum-full-list { margin-top: 620px; }
            .side-image-container { margin-top: 201px; }
            .cross-image-container { margin-top: 365px; }
            .circle-image-container { margin-top: 524px; }
            .tables-image-container { margin-top: 382px; }
        }
        /* --- END OF RESPONSIVE STYLES --- */
    </style>
</head>
<body>
    <div class="master-container">
        <div class="side-panel">
            <div class="entity-list-wrapper" id="princes-list-desktop-main"><h2>Princes</h2><ul></ul></div>
            <div class="dee-container">
                <h2>John Dee</h2>
                <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/John%20Dee.png" alt="John Dee Portrait" id="dee-thumbnail">
            </div>
            <div class="entity-list-wrapper" id="bonorum-full-list"><h2>Kings, Princes & Ministers</h2><ul></ul></div>
        </div>
        <div class="central-content">
            <div class="table-container" id="table-container">
                <h1>The Holy Table</h1>
                <div class="holy-table" id="holy-table-grid"></div>
            </div>
            <div class="loagaeth-container" id="loagaeth-container">
                <h2>Loagaeth Tablet</h2>
                <div class="loagaeth-table" id="loagaeth-table-grid"></div>
            </div>
            <div class="bonorum-cross-container">
                <h2>Sigillum Dei Aemeth</h2>
                <div class="bonorum-cross-wrapper" id="bonorum-cross"></div>
                <div class="bonorum-diagram-container" id="bonorum-diagram-container"></div>
                <div class="planetary-kings-container" id="planetary-kings-container"></div>
            </div>
        </div>
        <div class="side-panel">
            <div class="font-toggle-wrapper">
                <button id="toggle-font-btn">Enochian</button>
            </div>
            <div class="entity-list-wrapper" id="kings-list-desktop-main"><h2>Kings</h2><ul></ul></div>
            <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/holytable.png" alt="The Holy Table Diagram" id="holy-table-image-thumbnail">
            <div class="side-image-container">
                <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/table.png" alt="Practice Table" id="loagaeth-practice-thumbnail">
            </div>
            <div class="cross-image-container">
                <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/cross.png" alt="Cross Diagram" id="cross-image-thumbnail">
            </div>
            <div class="circle-image-container">
                <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/circle.png" alt="Circle Diagram" id="circle-image-thumbnail">
            </div>
            <div class="tables-image-container">
                <img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/tables.png" alt="Tables Diagram" id="tables-image-thumbnail">
            </div>
        </div>
    </div>
    <div id="image-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/holytable.png" alt="Enlarged Holy Table Diagram"></div>
    <div id="dee-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/John%20Dee.png" alt="Enlarged John Dee Portrait"><div class="dee-description"><b>John Dee</b> (1527-1609) był angielskim matematykiem, astronomem, astrologiem i okultystą, a także doradcą królowej Elżbiety I. Manuskrypt <b>Sloane 3188</b>, zawierający zapisy jego anielskich rozmów, powstał w latach <b>1582-1583</b> we współpracy z medium <b>Edwardem Kelleyem</b>.</div></div>
    <div id="loagaeth-practice-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/table.png" alt="Enlarged Practice Table"></div>
    <div id="cross-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/cross.png" alt="Enlarged Cross Diagram"></div>
    <div id="circle-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/circle.png" alt="Enlarged Circle Diagram"></div>
    <div id="tables-lightbox" class="zoom-lightbox"><img src="https://raw.githubusercontent.com/0-skar/3188/refs/heads/main/tables.png" alt="Enlarged Tables Diagram"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const activeKeys = new Set();
        let interactionState = 0;
        const loagaethCellMatrix = [];
        const bonorumCellMap = new Map();
        const letterCells = new Map();
        const GRID_SIZE = 23;
        let isEnochianActive = false;
        const latinToEnochianMap = { 'A': 'a', 'B': 'b', 'C': 'c', 'K': 'c', 'D': 'd', 'E': 'e', 'F': 'f', 'G': 'g', 'H': 'h', 'I': 'i', 'J': 'i', 'Y': 'i', 'L': 'l', 'M': 'm', 'N': 'n', 'O': 'o', 'P': 'p', 'Q': 'q', 'R': 'r', 'S': 's', 'T': 't', 'U': 'u', 'V': 'u', 'W': 'u', 'X': 'x', 'Z': 'z' };
        
        let animationState = {
            timer: null,
            kingId: null,
            currentRowIndex: 0,
            isPlaying: false
        };

        const enochianData = { data_strings: { left_wall: "arrlueogaoitfrelrsman", top_wall: "nggdofooeeoneglssnoso", right_wall: "lnnyaoauaanbblmpseaoi", bottom_wall: "aspplggzeooeeoanlrlln" }, entities: [ { key: "prince_1", name: "Bagenol", rank: "Prince", side: 'left', startPosOnWall: 1 },{ key: "prince_2", name: "Bralges", rank: "Prince", side: 'left', startPosOnWall: 2 },{ key: "prince_3", name: "Brorges", rank: "Prince", side: 'left', startPosOnWall: 3 },{ key: "prince_4", name: "Blisdon", rank: "Prince", side: 'left', startPosOnWall: 4 },{ key: "prince_5", name: "Butmono", rank: "Prince", side: 'left', startPosOnWall: 5 },{ key: "prince_6", name: "Befafes", rank: "Prince", side: 'left', startPosOnWall: 6 },{ key: "prince_7", name: "Bornogo", rank: "Prince", side: 'left', startPosOnWall: 7 }, { key: "king_1", name: "Baligon", rank: "King", side: 'right', startPosOnWall: 7 },{ key: "king_2", name: "Bobogel", rank: "King", side: 'right', startPosOnWall: 6 },{ key: "king_3", "name": "Babalel", rank: "King", side: 'right', startPosOnWall: 5 },{ key: "king_4", name: "Bynepor", rank: "King", side: 'right', startPosOnWall: 4 },{ key: "king_5", "name": "Bnaspol", rank: "King", side: 'right', startPosOnWall: 3 },{ key: "king_6", name: "Bnapsen", rank: "King", side: 'right', startPosOnWall: 2 },{ key: "king_7", name: "Blumaza", rank: "King", side: 'right', startPosOnWall: 1 } ] };
        const bonorumData = { tables: { north: [[[7,"A"],[21,"O"],[1,"A"],[26,"E"],[48,"A"],[24,"A"],[13,"R"],[6,"A"],[7,"S"],[29,"A"],[15,"B"],[23,"I"],[8,"B"],[17,"Z"]],[[34,"I"],[8,"O"],[29,"N"],[2,"O"],[33,"A"],[6,"M"],[25,"E"],[36,"A"],[39,"S"],[12,"A"],[30,"O"],[1,"L"],[10,"S"],[21,"N"]],[[49,"A"],[4,"E"],[35,"A"],[40,"M"],[18,"L"],[28,"M"],[23,"L"],[5,"V"],[31,"S"],[25,"L"],[45,"B"],[26,"N"],[32,"N"],[3,"P"]],[[39,"V"],[47,"L"],[3,"A"],[5,"L"],[15,"A"],[36,"N"],[30,"R"],[18,"I"],[19,"A"],[48,"R"],[4,"S"],[27,"R"],[34,"N"],[24,"L"]],[[20,"E"],[19,"R"],[45,"A"],[37,"R"],[32,"I"],[17,"A"],[41,"A"],[38,"R"],[44,"G"],[37,"A"],[20,"R"],[16,"T"],[2,"R"],[22,"N"]],[[10,"A"],[38,"O"],[16,"V"],[27,"A"],[12,"R"],[43,"L"],[22,"Y"],[49,"M"],[43,"V"],[35,"L"],[47,"I"],[9,"F"],[33,"R"],[42,"I"]],[[9,"E"],[44,"A"],[11,"E"],[42,"L"],[31,"A"],[14,"N"],[46,"V"],[13,"I"],[46,"S"],[11,"R"],[41,"R"],[40,"I"],[28,"I"],[14,"A"]]], left: [[[14,"E"],[49,"E"],[7,"F"],[25,"A"],[13,"I"],[47,"F"],[16,"O"]],[[46,"A"],[36,"N"],[44,"L"],[42,"N"],[18,"M"],[45,"O"],[6,"L"]],[[12,"O"],[41,"O"],[26,"I"],[43,"A"],[29,"L"],[39,"B"],[33,"S"]],[[48,"T"],[31,"O"],[2,"O"],[32,"B"],[9,"S"],[38,"A"],[8,"L"]],[[28,"S"],[15,"L"],[27,"A"],[10,"O"],[3,"O"],[30,"S"],[20,"E"]],[[40,"L"],[34,"N"],[37,"S"],[19,"P"],[4,"E"],[5,"O"],[22,"R"]],[[24,"R"],[1,"N"],[35,"O"],[23,"N"],[11,"E"],[21,"N"],[17,"A"]]], center: Array.from({ length: 7 }, (_, r) => Array.from({ length: 7 }, (_, c) => [r * 7 + c + 1, "B"])), right: [[[6,"M"],[41,"T"],[39,"C"],[19,"G"],[49,"N"],[45,"L"],[14,"G"]],[[31,"P"],[25,"M"],[2,"N"],[18,"N"],[44,"E"],[8,"O"],[30,"R"]],[[7,"L"],[15,"A"],[38,"M"],[32,"O"],[43,"M"],[29,"S"],[28,"L"]],[[35,"D"],[37,"L"],[3,"N"],[13,"S"],[42,"I"],[12,"N"],[33,"I"]],[[1,"I"],[17,"P"],[16,"M"],[46,"D"],[5,"M"],[40,"N"],[21,"E"]],[[27,"N"],[23,"S"],[4,"G"],[36,"P"],[26,"P"],[47,"N"],[20,"M"]],[[9,"A"],[10,"M"],[24,"C"],[22,"E"],[34,"O"],[11,"N"],[48,"F"]]], south: [[[36,"E"],[47,"E"],[14,"L"],[27,"F"],[49,"D"],[13,"L"],[16,"N"],[8,"G"],[41,"I"],[16,"O"],[48,"O"],[43,"A"],[17,"A"],[49,"O"]],[[12,"L"],[32,"A"],[26,"G"],[24,"O"],[41,"R"],[31,"L"],[19,"O"],[32,"D"],[19,"I"],[44,"N"],[13,"F"],[47,"G"],[38,"I"],[3,"I"]],[[22,"O"],[29,"O"],[2,"G"],[7,"D"],[25,"R"],[1,"O"],[5,"P"],[7,"E"],[35,"A"],[2,"O"],[27,"A"],[42,"G"],[10,"E"],[18,"T"]],[[6,"A"],[15,"E"],[34,"O"],[4,"M"],[33,"E"],[30,"E"],[20,"L"],[31,"A"],[12,"G"],[25,"A"],[20,"A"],[40,"P"],[15,"L"],[29,"P"]],[[37,"E"],[9,"E"],[18,"O"],[10,"L"],[21,"O"],[28,"E"],[3,"D"],[6,"G"],[23,"D"],[22,"P"],[1,"G"],[30,"G"],[5,"A"],[46,"V"]],[[17,"M"],[39,"A"],[35,"G"],[38,"L"],[8,"E"],[11,"L"],[23,"O"],[37,"G"],[9,"F"],[4,"E"],[24,"E"],[34,"F"],[33,"G"],[21,"F"]],[[44,"O"],[43,"Z"],[48,"R"],[40,"O"],[45,"B"],[42,"A"],[46,"N"],[36,"S"],[45,"I"],[26,"A"],[14,"O"],[39,"N"],[11,"O"],[28,"G"]]]}};
        const bonorumEntities = [ { id: 1, name: "Baligon", type: "King" }, { id: 2, name: "Bornogo", type: "Prince" }, { id: 3, name: "Bapnido", type: "Minister" }, { id: 4, name: "Besgeme", type: "Minister" }, { id: 5, name: "Blumapo", type: "Minister" }, { id: 6, name: "Bmamgal", type: "Minister" }, { id: 7, name: "Basledf", type: "Minister" }, { id: 8, name: "Bobogel", type: "King" }, { id: 9, name: "Befafes", type: "Prince" }, { id: 10, name: "Basmelo", type: "Minister" }, { id: 11, name: "Bernole", type: "Minister" }, { id: 12, name: "Branglo", type: "Minister" }, { id: 13, name: "Brisfli", type: "Minister" }, { id: 14, name: "Bnagole", type: "Minister" }, { id: 15, name: "Babalel", type: "King" }, { id: 16, "name": "Butmono", type: "Prince" }, { id: 17, name: "Bazpama", type: "Minister" }, { id: 18, name: "Blintom", type: "Minister" }, { id: 19, name: "Bragiop", type: "Minister" }, { id: 20, name: "Bermale", type: "Minister" }, { id: 21, name: "Bonefon", type: "Minister" }, { id: 22, name: "Bynepor", type: "King" }, { id: 23, name: "Blisdon", type: "Prince" }, { id: 24, name: "Balceor", type: "Minister" }, { id: 25, name: "Belmara", type: "Minister" }, { id: 26, name: "Benpagi", type: "Minister" }, { id: 27, name: "Barnafa", type: "Minister" }, { id: 28, name: "Bmilges", type: "Minister" }, { id: 29, name: "Bnaspol", type: "King" }, { id: 30, name: "Brorges", type: "Prince" }, { id: 31, name: "Baspalo", type: "Minister" }, { id: 32, name: "Binodab", type: "Minister" }, { id: 33, name: "Bariges", type: "Minister" }, { id: 34, name: "Binofosn", type: "Minister" }, { id: 35, name: "Baldago", type: "Minister" }, { id: 36, name: "Bnapsen", type: "King" }, { id: 37, name: "Bralges", type: "Prince" }, { id: 38, name: "Bormila", type: "Minister" }, { id: 39, name: "Buscnab", type: "Minister" }, { id: 40, name: "Bminpol", type: "Minister" }, { id: 41, name: "Bartiro", type: "Minister" }, { id: 42, name: "Bliigan", type: "Minister" }, { id: 43, name: "Blumaza", type: "King" }, { id: 44, name: "Bagenol", type: "Prince" }, { id: 45, name: "Bablibo", type: "Minister" }, { id: 46, name: "Busduna", type: "Minister" }, { id: 47, name: "Blingef", type: "Minister" }, { id: 48, name: "Barfort", type: "Minister" }, { id: 49, name: "Bamnode", type: "Minister" } ].map(e => ({...e, key: `bon_${e.id}`}));
        const planetaryKingsData = [ { id: "king-bobogel", title: "Sunday - Bobogel", grid: [ "LEENARB", "LNANAEB", "ROEMNAB", "LEAORIB", "NEICIAB", "AOIDIAB" ] }, { id: "king-blumaza", title: "Monday - Blumaza", grid: [ "OESNGLE", "AVZNILN", "YLLMAFS", "NRSOGOO", "NRRCPRN", "LABDGRE" ] }, { id: "king-babalel", title: "Tuesday - Babalel", grid: [ "EILOMFO", "NEOTPTA", "SAGACIY", "ONEDPON", "NOONMAN", "ETEVLGL" ] }, { id: "king-bnaspol", title: "Wednesday - Bnaspol", grid: [ "ELGNSEB", "NLINZVB", "SFAMLLB", "OOGOSRS", "NRPCRRB", "ergdbab" ] }, { id: "king-bynepor", title: "Thursday - Bynepor", grid: [ "BBARNFL", "BBAIGAO", "BBALPAE", "BBANIFG", "BBOSNIA", "BBASNOD" ] }, { id: "king-baligon", title: "Friday - Baligon", grid: [ "AOAYNNL", "LBBNAAV", "IOAESPM", "GGLPPSA", "OEEOOEZ", "NLLRLNA" ] }, { id: "king-bnapsen", title: "Saturday - Bnapsen", grid: [ "BANSSZE", "BYAPARE", "BNAMGEN", "BNVAGES", "BLBOPOO", "BABEPEN" ] } ];
        const PERIMETER_STRING = enochianData.data_strings.left_wall + enochianData.data_strings.top_wall + enochianData.data_strings.right_wall + enochianData.data_strings.bottom_wall;
        const entitiesByKey = new Map(enochianData.entities.map(e => [e.key, e]));
        const entitiesByName = new Map(enochianData.entities.map(e => [e.name, e]));
        
        enochianData.entities.forEach(entity => {
            entity.trace = ((side, startPosOnWall) => {
                const trace = [];
                let positionOffset = (side === 'left') ? 0 : 42;
                trace.push(startPosOnWall + positionOffset);
                let currentIndex = startPosOnWall - 1;
                for (let i = 0; i < 5; i++) {
                    currentIndex = (currentIndex + 7) % 42;
                    trace.push(currentIndex + 1 + positionOffset);
                }
                return trace;
            })(entity.side, entity.startPosOnWall);
        });

        function addPlanetaryHighlightsForRow(kingId, rowIndex) {
            if (kingId === undefined || rowIndex === undefined) return;
            if (kingId === 'king-blumaza') {
                const sectorStartIds = [1, 8, 15, 22, 29, 36, 43];
                const sectorIndex = (rowIndex + 1) % 7;
                const startId = sectorStartIds[sectorIndex];
                if (!startId) return;
                const kingForThisRow = bonorumEntities.find(e => e.id === startId);
                const princeForThisRow = bonorumEntities.find(e => e.id === startId + 1);
                if (!kingForThisRow || !princeForThisRow) return;
                const holyTableKing = entitiesByName.get(kingForThisRow.name);
                const holyTablePrince = entitiesByName.get(princeForThisRow.name);
                const password = planetaryKingsData.find(k => k.id === kingId).grid[rowIndex];
                const letterForKing = password.charAt(0).toLowerCase();
                const letterForPrince = password.charAt(1).toLowerCase();
                const sdaLocationMap = [ { table: 'bonorum-table-north', half: 'left' }, { table: 'bonorum-table-north', half: 'left' }, { table: 'bonorum-table-north', half: 'right' }, { table: 'bonorum-table-right' }, { table: 'bonorum-table-south', half: 'right' }, { table: 'bonorum-table-south', half: 'left' }, { table: 'bonorum-table-left' } ];
                for (let i = 0; i < 7; i++) {
                    const targetEntity = bonorumEntities.find(e => e.id === startId + i);
                    if (!targetEntity) continue;
                    const highlightClass = `planetary-${targetEntity.type.toLowerCase()}-highlight`;
                    const diagramPattern = [1, 1, 2, 3, 4, 5, 6];
                    const diagramEl = document.querySelector(`.bonorum-diagram-name[data-key="${targetEntity.key}"]`);
                    if (diagramEl) {
                        const rect = diagramEl.querySelector(`.diagram-text-bg[data-char-index="${diagramPattern[i]}"]`);
                        if (rect) rect.classList.add(highlightClass);
                    }
                    const location = sdaLocationMap[i];
                    if (location) {
                        const sdaCells = bonorumCellMap.get(targetEntity.id) || [];
                        for (const cell of sdaCells) {
                            const parentTableId = cell.closest('.bonorum-table').id;
                            if (parentTableId !== location.table) continue;
                            let shouldHighlight = false;
                            if (location.half === 'left' && parseInt(cell.dataset.col) < 7) shouldHighlight = true;
                            else if (location.half === 'right' && parseInt(cell.dataset.col) >= 7) shouldHighlight = true;
                            else if (!location.half) shouldHighlight = true;
                            if (shouldHighlight) cell.classList.add(highlightClass);
                        }
                    }
                }
                if (holyTableKing) {
                    const htCell = letterCells.get(holyTableKing.trace[0]);
                    if (htCell) htCell.classList.add('planetary-king-highlight');
                }
                if (holyTablePrince) {
                    const htCell = letterCells.get(holyTablePrince.trace[0]);
                    if (htCell) htCell.classList.add('planetary-prince-highlight');
                }
                if (holyTableKing) {
                    const searchPool = findLoagaethCellsForEntity(holyTableKing);
                    const targetCell = searchPool.find(cell => {
                        const cellChar = cell.textContent.toLowerCase();
                        if (cellChar === letterForKing) return true;
                        if ((letterForKing === 'u' || letterForKing === 'v') && (cellChar === 'u' || cellChar === 'v')) return true;
                        return false;
                    });
                    if (targetCell) targetCell.classList.add('planetary-king-highlight');
                }
                if (holyTablePrince) {
                    const searchPool = findLoagaethCellsForEntity(holyTablePrince);
                    const targetCell = searchPool.find(cell => {
                        const cellChar = cell.textContent.toLowerCase();
                        if (cellChar === letterForPrince) return true;
                        if ((letterForPrince === 'u' || letterForPrince === 'v') && (cellChar === 'u' || cellChar === 'v')) return true;
                        return false;
                    });
                    if (targetCell) targetCell.classList.add('planetary-prince-highlight');
                }
                return;
            }
            const kingToStartEntityId = { 'king-baligon': 1, 'king-bobogel': 8, 'king-babalel': 15, 'king-bynepor': 22, 'king-bnaspol': 29, 'king-bnapsen': 36 };
            const sectorStartIds = [1, 8, 15, 22, 29, 36, 43];
            let startId;
            if (kingId === 'king-bobogel') {
                const sectorIndex = (rowIndex + 1) % 7;
                startId = sectorStartIds[sectorIndex];
            } else {
                startId = kingToStartEntityId[kingId];
            }
            if (!startId) return;
            for (let i = 0; i < 7; i++) {
                const targetEntity = bonorumEntities.find(e => e.id === startId + i);
                if (!targetEntity) continue;
                const letterIndexInName = 6 - i;
                const highlightClass = `planetary-${targetEntity.type.toLowerCase()}-highlight`;
                const diagramEl = document.querySelector(`.bonorum-diagram-name[data-key="${targetEntity.key}"]`);
                if (diagramEl) {
                    const rect = diagramEl.querySelector(`.diagram-text-bg[data-char-index="${letterIndexInName}"]`);
                    if (rect) rect.classList.add(highlightClass);
                }
                const holyTableEntity = entitiesByName.get(targetEntity.name);
                if (holyTableEntity) {
                    const traceIndex = letterIndexInName - 1;
                    if (traceIndex >= 0 && traceIndex < holyTableEntity.trace.length) {
                        const htPosition = holyTableEntity.trace[traceIndex];
                        const htCell = letterCells.get(htPosition);
                        if (htCell) htCell.classList.add(highlightClass);
                    }
                    const nameWithoutB = holyTableEntity.name.substring(1).toLowerCase();
                    if (letterIndexInName > 0) {
                        const letterIndexInShortName = letterIndexInName - 1;
                        const charToFind = nameWithoutB[letterIndexInShortName];
                        const searchPool = findLoagaethCellsForEntity(holyTableEntity);
                        let occurrenceTarget = 0;
                        for (let k = 0; k <= letterIndexInShortName; k++) {
                            if (nameWithoutB[k] === charToFind) occurrenceTarget++;
                        }
                        let foundCount = 0;
                        for (const cell of searchPool) {
                            if (cell.dataset.latinChar.toLowerCase() === charToFind) {
                                foundCount++;
                                if (foundCount === occurrenceTarget) {
                                    cell.classList.add(highlightClass);
                                    break;
                                }
                            }
                        }
                    }
                }
                const sdaCells = bonorumCellMap.get(targetEntity.id) || [];
                for (const cell of sdaCells) {
                    const parentTableId = cell.closest('.bonorum-table')?.id;
                    const colIndex = parseInt(cell.dataset.col);
                    let shouldHighlight = false;
                    switch(i) {
                        case 0: if (parentTableId === 'bonorum-table-left') shouldHighlight = true; break;
                        case 1: if (parentTableId === 'bonorum-table-south' && colIndex < 7) shouldHighlight = true; break;
                        case 2: if (parentTableId === 'bonorum-table-south' && colIndex >= 7) shouldHighlight = true; break;
                        case 3: if (parentTableId === 'bonorum-table-right') shouldHighlight = true; break;
                        case 4: if (parentTableId === 'bonorum-table-north' && colIndex >= 7) shouldHighlight = true; break;
                        case 5: if (parentTableId === 'bonorum-table-north' && colIndex < 7) shouldHighlight = true; break;
                        case 6: if (parentTableId === 'bonorum-table-center') shouldHighlight = true; break;
                    }
                    if (shouldHighlight) {
                        cell.classList.add(highlightClass);
                    }
                }
            }
        }

        function updateAllVisuals() { 
            document.querySelectorAll('.letter-cell, .loagaeth-cell, .center-diagram-cell, .bonorum-cell').forEach(c => c.className = c.className.split(' ').filter(cn => !cn.endsWith('-highlight') && !cn.endsWith('-point')).join(' '));
            document.querySelectorAll('button.active, .bonorum-diagram-name.active').forEach(el => el.classList.remove('active', 'king', 'prince', 'minister'));
            
            for (const key of activeKeys) { 
                const entityData = entitiesByKey.get(key); 
                const bonorumEntity = bonorumEntities.find(be => be.key === key || (entityData && be.name === entityData.name)); 
                
                if (entityData) { 
                    const isKing = entityData.rank === 'King';
                    entityData.trace.forEach((pos, index) => { 
                        const cell = letterCells.get(pos); 
                        if (cell) {
                            cell.classList.add(isKing ? 'king-highlight' : 'prince-highlight');
                            if (index === 0) cell.classList.add(isKing ? 'king-start-point' : 'prince-start-point');
                        } 
                    }); 
                    if (interactionState === 2) { 
                        const nameFragment = entityData.name.substring(1).toLowerCase(); 
                        let targetCells = findLoagaethCellsForEntity(entityData); 
                        let nameChars = nameFragment.split('');
                        let charPositions = {};
                        nameChars.forEach((char, index) => {
                            if(!charPositions[char]) charPositions[char] = [];
                            charPositions[char].push(index);
                        });
                        let nameHighlightClass = isKing ? 'loagaeth-king-name-highlight' : 'loagaeth-prince-name-highlight';
                        let cellCharCounters = {};
                        targetCells.forEach(cell => {
                            let cellChar = cell.dataset.latinChar.toLowerCase();
                             if(cellChar === 'v') cellChar = 'u'; // Treat v as u
                            let charToMatch = cellChar;
                            if(!cellCharCounters[charToMatch]) cellCharCounters[charToMatch] = 0;
                            let currentCount = cellCharCounters[charToMatch];
                            if(nameFragment.includes(charToMatch)) {
                                let indicesInName = nameFragment.split('').map((c, i) => (c === charToMatch || (charToMatch === 'u' && (c === 'u' || c === 'v'))) ? i : -1).filter(i => i !== -1);
                                if(currentCount < indicesInName.length) {
                                    cell.classList.add(nameHighlightClass);
                                }
                            }
                            cellCharCounters[charToMatch]++;
                        });
                    } 
                    document.querySelectorAll(`#princes-list-desktop-main button[data-key="${key}"], #kings-list-desktop-main button[data-key="${key}"]`).forEach(btn => btn.classList.add('active')); 
                } 
                if (bonorumEntity) { 
                    const highlightClass = `${bonorumEntity.type.toLowerCase()}-highlight`;
                    (bonorumCellMap.get(bonorumEntity.id) || []).forEach(cell => cell.classList.add(highlightClass));
                    document.querySelector(`#bonorum-full-list button[data-key="${bonorumEntity.key}"]`)?.classList.add('active'); 
                    const diagramEl = document.querySelector(`.bonorum-diagram-name[data-key="${bonorumEntity.key}"]`); 
                    if (diagramEl) diagramEl.classList.add('active', bonorumEntity.type.toLowerCase()); 
                } 
            } 
            if (interactionState === 1) { 
                document.querySelectorAll('.loagaeth-cell').forEach(cell => { 
                    const r = parseInt(cell.dataset.row), c = parseInt(cell.dataset.col); 
                    if (r >= 3 && r <= 5 && c >= 4 && c <= 7) cell.classList.add('loagaeth-key-highlight'); 
                }); 
                document.querySelectorAll('.center-diagram-cell').forEach(cell => cell.classList.add('highlight')); 
            } 
        }

        function createHolyTable() { const grid = document.getElementById('holy-table-grid'); const posToCoord = new Map(); for (let i = 0; i < 21; i++) posToCoord.set(i + 1, { r: 22 - i, c: 1 }); for (let i = 0; i < 21; i++) posToCoord.set(i + 22, { r: 1, c: 2 + i }); for (let i = 0; i < 21; i++) posToCoord.set(i + 43, { r: 2 + i, c: 23 }); for (let i = 0; i < 21; i++) posToCoord.set(i + 64, { r: 23, c: 22 - i }); const centralLetters = [["O","I","T"],["R","L","U"],["N","L","R"],["E","O","O"]]; const startRow = Math.floor((GRID_SIZE - 4) / 2) + 1, startCol = Math.floor((GRID_SIZE - 3) / 2) + 1; grid.innerHTML = ''; for (let r = 1; r <= GRID_SIZE; r++) { for (let c = 1; c <= GRID_SIZE; c++) { const cell = document.createElement('div'); cell.classList.add('grid-cell'); if ((r === 1 || r === GRID_SIZE) && (c === 1 || c === GRID_SIZE)) { cell.classList.add('corner-cell'); const letter = 'B'; cell.textContent = letter; cell.dataset.latinChar = letter; } else if (r >= startRow && r < startRow + 4 && c >= startCol && c < startCol + 3) { cell.classList.add('center-diagram-cell'); const letter = centralLetters[r - startRow][c - startCol]; cell.textContent = letter; cell.dataset.latinChar = letter; } else if (r === 1 || r === GRID_SIZE || c === 1 || c === GRID_SIZE) { for (const [pos, coords] of posToCoord.entries()) { if (coords.r === r && coords.c === c) { cell.classList.add('letter-cell'); cell.id = `cell-${pos}`; const letter = PERIMETER_STRING[pos - 1]; cell.textContent = letter.toUpperCase(); cell.dataset.latinChar = letter.toUpperCase(); letterCells.set(pos, cell); break; } } } grid.appendChild(cell); } } const bg = document.createElement('div'); bg.className = 'inner-grid-background'; grid.appendChild(bg); }
        function createLoagaethTable() { const loagaethGrid = document.getElementById('loagaeth-table-grid'); loagaethGrid.style.gridTemplateColumns = `repeat(12, var(--cell-size))`; const tabletLetters = [['l','o','n','e','g','a','n','o','g','i','l','a'],['o','g','o','n','r','o','l','e','g','o','b','o'],['s','e','f','a','f','e','l','e','l','a','b','a'],['o','n','o','m','t','u','r','o','p','e','n','y'],['n','o','d','s','i','l','l','o','p','s','a','n'],['s','e','g','r','o','r','n','e','s','p','a','n'],['s','e','g','l','a','r','a','z','a','m','u','l']]; loagaethGrid.innerHTML = ''; loagaethCellMatrix.length = 0; tabletLetters.forEach((row, r) => { const rowArray = []; row.forEach((letter, c) => { const cell = document.createElement('div'); cell.classList.add('loagaeth-cell'); cell.textContent = letter; cell.dataset.latinChar = letter.toUpperCase(); cell.dataset.row = r; cell.dataset.col = c; loagaethGrid.appendChild(cell); rowArray.push(cell); }); loagaethCellMatrix.push(rowArray); }); if (!document.getElementById('loagaeth-clickable-area')) { const clickableArea = document.createElement('div'); clickableArea.id = 'loagaeth-clickable-area'; const container = document.getElementById('loagaeth-container'); container.style.position = 'relative'; container.appendChild(clickableArea); const updateClickableArea = () => { const table = document.getElementById('loagaeth-table-grid'); if(!table) return; const cellSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-size').replace('px', '')); const gridPadding = 5; clickableArea.style.top = `${table.offsetTop + gridPadding + (3 * cellSize)}px`; clickableArea.style.left = `${table.offsetLeft + gridPadding + (4 * cellSize)}px`; clickableArea.style.width = `${4 * cellSize}px`; clickableArea.style.height = `${3 * cellSize}px`; }; updateClickableArea(); window.addEventListener('resize', updateClickableArea); } }
        function createEntityLists() { const listTargets = [{ type: 'Prince', el: document.querySelector('#princes-list-desktop-main ul') }, { type: 'King', el: document.querySelector('#kings-list-desktop-main ul') }]; listTargets.forEach(target => target.el.innerHTML = ''); enochianData.entities.forEach(entity => { const li = document.createElement('li'); const button = document.createElement('button'); button.textContent = entity.name; button.dataset.key = entity.key; li.appendChild(button); listTargets.forEach(target => { if (entity.rank === target.type) { target.el.appendChild(li.cloneNode(true)); } }); }); }
        function createBonorumCross() { const wrapper = document.getElementById('bonorum-cross'); wrapper.innerHTML = ''; const tableKeys = ['north', 'left', 'center', 'right', 'south']; const createTable = (tableKey, data) => { const tableEl = document.createElement('div'); tableEl.classList.add('bonorum-table'); tableEl.id = `bonorum-table-${tableKey}`; const numRows = data.length; if (numRows === 0) return tableEl; const numCols = data[0].length; let cellWidthVar = (tableKey === 'north' || tableKey === 'south') ? `calc(var(--b-cell-size) / 2)` : 'var(--b-cell-size)'; tableEl.style.gridTemplateRows = `repeat(${numRows}, var(--b-cell-size))`; tableEl.style.gridTemplateColumns = `repeat(${numCols}, ${cellWidthVar})`; data.forEach((row, r_index) => { row.forEach((cellData, c_index) => { const cell = document.createElement('div'); cell.classList.add('bonorum-cell'); cell.dataset.col = c_index; cell.dataset.row = r_index; const [num, letter] = cellData; cell.innerHTML = (num > 0 || (letter && letter.trim() !== '')) ? `<span>${num || ''}</span>${letter}` : ' '; if (letter) cell.dataset.latinChar = letter.toUpperCase(); if (num > 0) { if (!bonorumCellMap.has(num)) bonorumCellMap.set(num, []); bonorumCellMap.get(num).push(cell); } tableEl.appendChild(cell); }); }); return tableEl; }; tableKeys.forEach(key => { if (bonorumData.tables[key]) { wrapper.appendChild(createTable(key, bonorumData.tables[key])); } }); }
        function createBonorumList() { const listEl = document.querySelector('#bonorum-full-list ul'); listEl.innerHTML = ''; bonorumEntities.forEach(entity => { const li = document.createElement('li'); const button = document.createElement('button'); button.textContent = `${entity.id} ${entity.name}`; button.dataset.key = entity.key; if (entity.type === "King" || entity.type === "Prince") { button.style.fontWeight = 'bold'; } li.appendChild(button); listEl.appendChild(li); }); }
        function createBonorumDiagram() { const container = document.getElementById('bonorum-diagram-container'); container.innerHTML = ''; const svgNS = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('viewBox', '-300 -300 600 600'); const mainGroup = document.createElementNS(svgNS, 'g'); svg.appendChild(mainGroup); const letterRadii = [110, 135, 160, 185, 210, 235, 260]; const symbolRadius = 92.5; const numberRadius = 75; const sectorNumberRadius = 285; const ringRadii = [275, 247.5, 222.5, 197.5, 172.5, 147.5, 122.5, 100, 85, 65]; const totalEntities = 49; const anglePerEntity = 360 / totalEntities; const backgroundCircle = document.createElementNS(svgNS, 'circle'); backgroundCircle.setAttribute('cx', 0); backgroundCircle.setAttribute('cy', 0); backgroundCircle.setAttribute('r', ringRadii[0]); backgroundCircle.setAttribute('fill', 'var(--table-bg)'); mainGroup.appendChild(backgroundCircle); ringRadii.forEach(r => { const circle = document.createElementNS(svgNS, 'circle'); circle.setAttribute('cx', 0); circle.setAttribute('cy', 0); circle.setAttribute('r', r); circle.classList.add('diagram-ring'); mainGroup.appendChild(circle); }); for (let i = 0; i < 7; i++) { const spokeAngle = -90 + (anglePerEntity * (i * 7 - 0.5)); const spoke = document.createElementNS(svgNS, 'line'); spoke.setAttribute('x1', 0); spoke.setAttribute('y1', 0); const x2 = ringRadii[0] * Math.cos(spokeAngle * Math.PI / 180); const y2 = ringRadii[0] * Math.sin(spokeAngle * Math.PI / 180); spoke.setAttribute('x2', x2); spoke.setAttribute('y2', y2); spoke.classList.add('diagram-spoke'); mainGroup.appendChild(spoke); const sectorAngle = spokeAngle + (anglePerEntity * 3.5); const numX = sectorNumberRadius * Math.cos(sectorAngle * Math.PI / 180); const numY = sectorNumberRadius * Math.sin(sectorAngle * Math.PI / 180); const sectorNumText = document.createElementNS(svgNS, 'text'); sectorNumText.setAttribute('x', numX); sectorNumText.setAttribute('y', numY); sectorNumText.textContent = `${i + 1}`; sectorNumText.classList.add('diagram-sector-number'); mainGroup.appendChild(sectorNumText); } bonorumEntities.forEach((entity, index) => { const nameGroup = document.createElementNS(svgNS, 'g'); nameGroup.dataset.key = entity.key; nameGroup.classList.add('bonorum-diagram-name'); const name = entity.name.toUpperCase(); const textAngle = -90 + (anglePerEntity * index); name.split('').forEach((char, charIndex) => { if (charIndex >= letterRadii.length) return; const radius = letterRadii[charIndex]; const charX = radius * Math.cos(textAngle * Math.PI / 180); const charY = radius * Math.sin(textAngle * Math.PI / 180); const bgSize = 14; const rect = document.createElementNS(svgNS, 'rect'); rect.setAttribute('x', charX - (bgSize / 2)); rect.setAttribute('y', charY - (bgSize / 2)); rect.setAttribute('width', bgSize); rect.setAttribute('height', bgSize); rect.setAttribute('transform', `rotate(${textAngle + 90} ${charX} ${charY})`); rect.classList.add('diagram-text-bg'); rect.dataset.charIndex = charIndex; nameGroup.appendChild(rect); const text = document.createElementNS(svgNS, 'text'); text.setAttribute('x', charX); text.setAttribute('y', charY); text.setAttribute('transform', `rotate(${textAngle + 90} ${charX} ${charY})`); text.textContent = char; text.dataset.latinChar = char.toUpperCase(); text.classList.add('diagram-text'); text.dataset.charIndex = charIndex; nameGroup.appendChild(text); }); mainGroup.appendChild(nameGroup); }); for (let i = 0; i < totalEntities; i++) { const angle = -90 + (i * anglePerEntity); const x = numberRadius * Math.cos(angle * Math.PI / 180); const y = numberRadius * Math.sin(angle * Math.PI / 180); const numText = document.createElementNS(svgNS, 'text'); numText.setAttribute('x', x); numText.setAttribute('y', y); numText.setAttribute('transform', `rotate(${angle + 90} ${x} ${y})`); numText.textContent = i + 1; numText.classList.add('diagram-number'); mainGroup.appendChild(numText); } const symbols = ['♀', '☉', '♂', '♃', '☿', '♄', '☽']; const targetNumbers = [1, 8, 15, 22, 29, 36, 43]; symbols.forEach((symbol, i) => { const numberIndex = targetNumbers[i] - 1; const angle = -90 + (anglePerEntity * numberIndex); const x = symbolRadius * Math.cos(angle * Math.PI / 180); const y = symbolRadius * Math.sin(angle * Math.PI / 180); const symbolText = document.createElementNS(svgNS, 'text'); symbolText.setAttribute('x', x); symbolText.setAttribute('y', y); symbolText.setAttribute('transform', `rotate(${angle + 90} ${x} ${y})`); symbolText.textContent = symbol; if (symbol === '☉') symbolText.id = 'bonorum-symbol-sun'; if (symbol === '☽') symbolText.id = 'bonorum-symbol-moon'; symbolText.classList.add('diagram-symbol'); mainGroup.appendChild(symbolText); }); container.appendChild(svg); }
        function createPlanetaryKingsGrids() {
            const container = document.getElementById('planetary-kings-container');
            container.innerHTML = '';
            planetaryKingsData.forEach(king => {
                const squareWrapper = document.createElement('div');
                squareWrapper.className = 'planetary-king-square';
                squareWrapper.id = king.id;
                const title = document.createElement('h3');
                title.textContent = king.title;
                squareWrapper.appendChild(title);
                if (['king-bobogel', 'king-blumaza'].includes(king.id)) {
                    const playButton = document.createElement('button');
                    playButton.className = 'play-button';
                    playButton.dataset.kingId = king.id;
                    playButton.innerHTML = `<div class="icon play-icon"></div><div class="icon pause-icon"></div>`;
                    squareWrapper.appendChild(playButton);
                }
                const grid = document.createElement('div');
                grid.className = 'planetary-king-grid';
                king.grid.forEach((rowString, rowIndex) => {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'planetary-king-row';
                    rowEl.dataset.kingId = king.id;
                    rowEl.dataset.rowIndex = rowIndex;
                    rowString.split('').forEach((char) => {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell letter-cell';
                        cell.textContent = char.toUpperCase();
                        cell.dataset.latinChar = char.toUpperCase();
                        rowEl.appendChild(cell);
                    });
                    grid.appendChild(rowEl);
                });
                squareWrapper.appendChild(grid);
                container.appendChild(squareWrapper);
            });
        }
        function toggleEnochianFont() { isEnochianActive = !isEnochianActive; const toggleBtn = document.getElementById('toggle-font-btn'); toggleBtn.classList.toggle('active-enochian', isEnochianActive); const elementsToTranslate = document.querySelectorAll('[data-latin-char]'); elementsToTranslate.forEach(el => { const latinChar = el.dataset.latinChar; if (isEnochianActive) { const enochianChar = latinToEnochianMap[latinChar] || latinChar; if (el.classList.contains('bonorum-cell') && el.querySelector('span')) { const span = el.querySelector('span').outerHTML; el.innerHTML = span + enochianChar; } else { el.textContent = enochianChar; } el.classList.add('enochian-font'); } else { if (el.classList.contains('bonorum-cell') && el.querySelector('span')) { const span = el.querySelector('span').outerHTML; el.innerHTML = span + latinChar; } else { el.textContent = latinChar; } el.classList.remove('enochian-font'); } }); }
        function findLoagaethCellsForEntity(entity) { if (!entity) return []; let targetCellsPool = []; if (entity.side === 'right') { const map = { 1: 6, 2: 5, 3: 4, 4: 3, 5: 2, 6: 1, 7: 0 }; if (loagaethCellMatrix[map[entity.startPosOnWall]]) { targetCellsPool = [...loagaethCellMatrix[map[entity.startPosOnWall]]].reverse(); } } else { const map = { 1: 0, 2: 6, 3: 5, 4: 4, 5: 3, 6: 2, 7: 1 }; if (loagaethCellMatrix[map[entity.startPosOnWall]]) { targetCellsPool = loagaethCellMatrix[map[entity.startPosOnWall]].slice(0, 6).reverse(); } } return targetCellsPool; }
        function clearPlanetaryHighlights() { document.querySelectorAll('.diagram-text-bg[class*="planetary-"], .planetary-king-highlight, .planetary-prince-highlight, .planetary-minister-highlight').forEach(el => { el.classList.remove('planetary-king-highlight', 'planetary-prince-highlight', 'planetary-minister-highlight'); }); }
        function updateAllPlanetaryHighlights() {
            clearPlanetaryHighlights();
            const sunSymbol = document.getElementById('bonorum-symbol-sun');
            if (sunSymbol) {
                const isSundaySelected = document.querySelector('.planetary-king-row.selected[data-king-id="king-bobogel"]');
                sunSymbol.classList.toggle('highlight', !!isSundaySelected);
            }
            const moonSymbol = document.getElementById('bonorum-symbol-moon');
            if (moonSymbol) {
                const isMondaySelected = document.querySelector('.planetary-king-row.selected[data-king-id="king-blumaza"]');
                moonSymbol.classList.toggle('highlight', !!isMondaySelected);
            }
            document.querySelectorAll('.planetary-king-row.selected').forEach(row => {
                const { kingId, rowIndex } = row.dataset;
                addPlanetaryHighlightsForRow(kingId, parseInt(rowIndex));
            });
        }
        function animateStep() {
            if (!animationState.isPlaying || !animationState.kingId) return;
            const kingRows = document.querySelectorAll(`#${animationState.kingId} .planetary-king-row`);
            if (kingRows.length === 0) {
                const button = document.querySelector(`.play-button[data-king-id="${animationState.kingId}"]`);
                if(button) toggleAnimation(button);
                return;
            }
            document.querySelectorAll('.planetary-king-row.selected').forEach(r => r.classList.remove('selected'));
            const currentRow = kingRows[animationState.currentRowIndex];
            if (currentRow) currentRow.classList.add('selected');
            updateAllPlanetaryHighlights();
            animationState.currentRowIndex = (animationState.currentRowIndex + 1) % kingRows.length;
        }
        function toggleAnimation(button) {
            if (!button) return;
            const kingIdToPlay = button.dataset.kingId;
            const wasPlayingThis = animationState.isPlaying && animationState.kingId === kingIdToPlay;
            if (animationState.isPlaying) {
                clearInterval(animationState.timer);
                const oldButton = document.querySelector(`.play-button[data-king-id="${animationState.kingId}"]`);
                if (oldButton) oldButton.classList.remove('playing');
                animationState.isPlaying = false;
                animationState.kingId = null;
            }
            if (!wasPlayingThis) {
                animationState.isPlaying = true;
                animationState.kingId = kingIdToPlay;
                animationState.currentRowIndex = 0;
                button.classList.add('playing');
                animateStep(); 
                animationState.timer = setInterval(animateStep, 1500);
            }
        }
        function handlePlanetaryKingRowClick(event) {
            const row = event.target.closest('.planetary-king-row');
            if (!row) return;
            if (animationState.isPlaying) {
                const playingButton = document.querySelector(`.play-button[data-king-id="${animationState.kingId}"]`);
                if (playingButton) toggleAnimation(playingButton); 
            }
            row.classList.toggle('selected');
            updateAllPlanetaryHighlights();
        }
        function handleContainerClick(event) {
            const playButton = event.target.closest('.play-button');
            if (playButton) toggleAnimation(playButton);
            else {
                const row = event.target.closest('.planetary-king-row');
                if (row) handlePlanetaryKingRowClick(event);
            }
        }
        function handleGenericClick(key) { if (!key) return; activeKeys.has(key) ? activeKeys.delete(key) : activeKeys.add(key); updateAllVisuals(); }
        function handleNameClick(event) { const button = event.target.closest('button'); if (button) handleGenericClick(button.dataset.key); }
        function handleDiagramClick(event) { const key = event.target.closest('.bonorum-diagram-name')?.dataset.key; if (!key) return; const bonorumEntity = bonorumEntities.find(e => e.key === key); if (!bonorumEntity) return; if (bonorumEntity.type === 'Minister') { handleGenericClick(key); } else { const holyTableEntity = entitiesByName.get(bonorumEntity.name); if (holyTableEntity) handleGenericClick(holyTableEntity.key); else handleGenericClick(key); } }
        function handleBonorumListClick(event) { const button = event.target.closest('button'); if (!button) return; const bonorumKey = button.dataset.key; const bonorumEntity = bonorumEntities.find(e => e.key === bonorumKey); if (!bonorumEntity) return; if (bonorumEntity.type === 'Minister') { handleGenericClick(bonorumKey); } else { const holyTableEntity = entitiesByName.get(bonorumEntity.name); if (holyTableEntity) handleGenericClick(holyTableEntity.key); } }
        function handleLoagaethKeyClick() { interactionState = (interactionState + 1) % 3; const loagaethGrid = document.getElementById('loagaeth-table-grid'); const allCells = loagaethGrid.querySelectorAll('.loagaeth-cell'); loagaethGrid.style.gridTemplateColumns = `repeat(12, var(--cell-size))`; allCells.forEach(cell => cell.style.gridColumn = ''); if (interactionState === 2) { loagaethGrid.style.gridTemplateColumns = `repeat(6, 1fr) 40px repeat(6, 1fr)`; allCells.forEach(cell => { if (parseInt(cell.dataset.col) >= 6) cell.style.gridColumn = `${parseInt(cell.dataset.col) + 2}`; }); } updateAllVisuals(); }
        
        createHolyTable(); createLoagaethTable(); createEntityLists(); createBonorumCross(); createBonorumList(); createBonorumDiagram(); createPlanetaryKingsGrids(); 
        
        document.getElementById('princes-list-desktop-main').addEventListener('click', handleNameClick);
        document.getElementById('kings-list-desktop-main').addEventListener('click', handleNameClick);
        document.getElementById('loagaeth-clickable-area').addEventListener('click', handleLoagaethKeyClick);
        document.getElementById('bonorum-full-list').addEventListener('click', handleBonorumListClick);
        document.getElementById('bonorum-diagram-container').addEventListener('click', handleDiagramClick);
        document.getElementById('planetary-kings-container').addEventListener('click', handleContainerClick);
        document.getElementById('toggle-font-btn').addEventListener('click', toggleEnochianFont);
        document.addEventListener('keydown', (event) => { if (event.key.toLowerCase() === 'e' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { toggleEnochianFont(); } });
        
        function setupZoomableLightbox(thumbnailId, lightboxId) { const thumbnail = document.getElementById(thumbnailId); const lightbox = document.getElementById(lightboxId); const img = lightbox.querySelector('img'); if (!thumbnail || !lightbox || !img) return; const zoomLevels = [1.5, 2.5, 4, 1]; let currentZoomLevel = 0; let scale = 1, panX = 0, panY = 0, isDragging = false, startX, startY, startPanX, startPanY; function applyTransform() { img.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; img.classList.toggle('pannable', scale > 1); } function resetTransform() { currentZoomLevel = 0; scale = 1; panX = 0; panY = 0; img.style.transition = 'none'; applyTransform(); setTimeout(() => { img.style.transition = ''; }, 10); } thumbnail.addEventListener('click', () => { lightbox.classList.add('active'); }); lightbox.addEventListener('click', (e) => { if (e.target === lightbox || e.target.classList.contains('dee-description')) { lightbox.classList.remove('active'); resetTransform(); } }); img.addEventListener('click', (e) => { e.stopPropagation(); if (isDragging) return; currentZoomLevel = (currentZoomLevel + 1) % zoomLevels.length; scale = zoomLevels[currentZoomLevel]; if (scale === 1) { panX = 0; panY = 0; } applyTransform(); }); img.addEventListener('mousedown', (e) => { if (scale <= 1) return; e.preventDefault(); isDragging = true; startX = e.clientX; startY = e.clientY; startPanX = panX; startPanY = panY; img.classList.add('dragging'); }); window.addEventListener('mousemove', (e) => { if (isDragging) { panX = startPanX + (e.clientX - startX); panY = startPanY + (e.clientY - startY); applyTransform(); } }); window.addEventListener('mouseup', () => { if (isDragging) { setTimeout(() => { isDragging = false; }, 50); img.classList.remove('dragging'); } }); }
        setupZoomableLightbox('holy-table-image-thumbnail', 'image-lightbox');
        setupZoomableLightbox('dee-thumbnail', 'dee-lightbox');
        setupZoomableLightbox('loagaeth-practice-thumbnail', 'loagaeth-practice-lightbox');
        setupZoomableLightbox('cross-image-thumbnail', 'cross-lightbox');
        setupZoomableLightbox('circle-image-thumbnail', 'circle-lightbox');
        setupZoomableLightbox('tables-image-thumbnail', 'tables-lightbox');
    });
</script>
</body>
</html>